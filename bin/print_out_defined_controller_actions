#!/usr/bin/env ruby
#this prints out methods defined in controllers and matching routes in config/routes.rb
methods = Dir.glob('./app/controllers/**/*.rb').map {|f| [f, File.readlines(f).select{|l| (l=~/def/)}]}

def resource_methods 
  %w(new index show destroy create update edit)
end

def match_a_controller_method? line
  resource_methods.select do |method| 
    line =~ /#{method}$/
  end
end

routes_file = File.readlines './config/routes.rb'

methods.each do |controller, lines|
  matching = lines.map do |l|
    match_a_controller_method?(l)
  end.flatten.compact

  controller_name = controller.gsub %r{./app/controllers/|_controller.rb}, ''
  resource = controller_name.gsub %r{.*/}, ''

  if matching.length == resource_methods.length
    puts "    #{resource} ALL routes are defined in controllers"
  else
    if matching.any?
      puts controller_name

      puts "    ROUTES: #{routes_file.select{|r| r=~ /#{resource}/ }.map{|l| l.gsub(/^\s*/, '')}}"
      puts "    , only: #{matching.map(&:to_sym).inspect}"
    end
  end
end
